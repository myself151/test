<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>利用者画面</title>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1>利用者画面</h1>
<p>現在番号: <span id="currentNumber">0</span></p>

<script>
const currentNumberElem = document.getElementById("currentNumber");
const socket = io();

// --- 番号リアルタイム更新 ---
socket.on("update", (data) => {
  currentNumberElem.textContent = data.currentNumber;
});

// --- 通知受信 ---
socket.on("notify", (data) => {
  if (Notification.permission === "granted") {
    new Notification(`あなたの番号 ${data.number} が5つ前になりました！`);
  }
});

// --- 通知許可リクエスト ---
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

// --- URLパラメータから番号自動登録 ---
const urlParams = new URLSearchParams(window.location.search);
const myNumber = parseInt(urlParams.get("num"));
if (myNumber) {
  fetch("/user/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ number: myNumber })
  }).then(res => res.json())
    .then(data => {
      if (data.success) {
        console.log("番号登録完了:", myNumber);
      }
    });
}

// --- フォールバック ポーリング（3秒ごと） ---
setInterval(async () => {
  try {
    const res = await fetch("/api/status", { cache: "no-store" });
    const data = await res.json();
    currentNumberElem.textContent = data.currentNumber;
  } catch (e) {
    console.error("番号取得エラー", e);
  }
}, 3000);
</script>
</body>
</html>
