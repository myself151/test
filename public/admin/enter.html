<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>管理者 - チェックイン</title>
</head>
<body>
<h1>チェックイン</h1>
<video id="video" width="400" height="300" autoplay></video>
<p>呼び出し番号: <span id="current">0</span></p>
<p id="message"></p>

<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script>
const videoElem = document.getElementById('video');
const currentElem = document.getElementById('current');
const msgElem = document.getElementById('message');

navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
  videoElem.srcObject = stream;
});

async function updateCurrent(){
  const res = await fetch('/user/current');
  const data = await res.json();
  currentElem.textContent = data.current || '0';
}
setInterval(updateCurrent,1000);

const html5QrCode = new Html5Qrcode("video");
html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
  async (decodedText, decodedResult)=>{
    const ticket = parseInt(decodedText);
    await fetch('/admin/checkin',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ticket})
    });
    msgElem.textContent = 'お進み下さい';
    setTimeout(()=>{msgElem.textContent=''},1000);
  },
  (errorMessage)=>{}
);
</script>
</body>
</html>
