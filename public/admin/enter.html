<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>入場チェックイン</title>
</head>
<body>
<h1>入場チェックイン</h1>
<video id="camera" autoplay></video>
<p>現在呼び出し番号: <span id="currentCall">-</span></p>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
const video = document.getElementById('camera');
const currentCall = document.getElementById('currentCall');

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(stream=>{video.srcObject=stream; video.play(); requestAnimationFrame(scan);})
.catch(err=>alert('カメラにアクセスできません: '+err));

function scan(){
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = jsQR(imageData.data,canvas.width,canvas.height);
  if(code){
    fetch('/admin/checkin',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ticket:code.data})
    }).then(r=>r.json()).then(resp=>{
      if(resp.ok){
        currentCall.innerText = code.data;
        setTimeout(()=>alert('お進みください'),1000);
      }
    });
  }
  requestAnimationFrame(scan);
}
</script>
</body>
</html>
