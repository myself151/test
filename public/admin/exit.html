<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>退場チェックアウト</title>
</head>
<body>
<h1>退場チェックアウト</h1>
<video id="camera" autoplay></video>
<p>現在場内人数: <span id="insideCount">0</span></p>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
const video = document.getElementById('camera');
const insideCount = document.getElementById('insideCount');

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(stream=>{video.srcObject=stream; video.play(); requestAnimationFrame(scan);})
.catch(err=>alert('カメラにアクセスできません: '+err));

function scan(){
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = jsQR(imageData.data,canvas.width,canvas.height);
  if(code){
    fetch('/admin/checkout',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ticket:code.data})
    }).then(r=>r.json()).then(resp=>{
      if(resp.ok) alert('チェックアウト完了: '+code.data);
    });
  }

  fetch('/user/current').then(r=>r.json()).then(data=>{
    const inside = data.notify.filter(t=>t).length;
    insideCount.innerText = inside;
  });

  requestAnimationFrame(scan);
}
</script>
</body>
</html>
