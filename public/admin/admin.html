<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>管理者画面</title>
<style>
  body { font-family: "Noto Sans JP", sans-serif; padding:20px; }
  input, button { font-size: 16px; margin: 5px; }
  #stats { margin-top: 20px; }
</style>
</head>
<body>
<h1>管理者画面</h1>

<h2>配布済み番号入力</h2>
<input type="text" id="distributedNumbers" placeholder="例: 1-12,15,18">
<button id="updateDistributed">更新</button>

<h2>PDF生成</h2>
<input type="text" id="pdfUrl" placeholder="整理券リンク URL">
<button id="generatePdf">PDF生成</button>

<h2>集計 / リセット</h2>
<button id="statsBtn">集計</button>
<button id="resetBtn">リセット</button>

<div id="stats"></div>

<script src="../script.js"></script>
<script>
const distributedInput = document.getElementById("distributedNumbers");
const updateBtn = document.getElementById("updateDistributed");
const statsDiv = document.getElementById("stats");

updateBtn.addEventListener("click", () => {
  const val = distributedInput.value.trim();
  let numbers = [];
  if(val) {
    val.split(",").forEach(range => {
      if(range.includes("-")){
        const [start,end] = range.split("-").map(Number);
        for(let i=start;i<=end;i++) numbers.push(i);
      } else {
        numbers.push(Number(range));
      }
    });
  }
  fetch("/admin/issue", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ distributed: numbers })
  }).then(r => r.json()).then(data=>{
    alert("配布済み番号を更新しました");
  });
});

// PDF生成
document.getElementById("generatePdf").addEventListener("click", () => {
  const url = document.getElementById("pdfUrl").value.trim();
  fetch("/admin/pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ start: 1, end: 12, url }) // ここは例として1-12
  }).then(r=>r.blob())
    .then(blob=>{
      const link = document.createElement("a");
      link.href = window.URL.createObjectURL(blob);
      link.download = "tickets.pdf";
      link.click();
    });
});

// 集計
document.getElementById("statsBtn").addEventListener("click", () => {
  fetch("/admin/stats").then(r=>r.json()).then(data=>{
    statsDiv.innerHTML = `
      配布済み番号数: ${data.distributed}<br>
      チェックイン人数: ${data.checkedIn}<br>
      チェックアウト人数: ${data.checkedOut}<br>
      現在番号: ${data.currentNumber}
    `;
  });
});

// リセット
document.getElementById("resetBtn").addEventListener("click", () => {
  if(confirm("本当にリセットしますか？")){
    fetch("/admin/reset", { method:"POST" }).then(r=>r.json()).then(()=>alert("リセットしました"));
  }
});
</script>
</body>
</html>
